<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Раздел содержит информацию о процессе разработки вебвью приложения для смарт-терминала.">
<meta name="keywords" content=" sample">
<title>Разработка вебвью приложения для смарт-терминала | Документация Эвотор</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/lavish-bootstrap.css">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/theme-orange.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Документация Эвотор</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="https://api.evotor.ru/docs/" target="_blank">Справочник API</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="Поиск...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Разработка вебвью приложения для смарт-терминала">{title}</a></li>',
                    noResultsText: 'Ничего не найдено',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle"> </li>
    
    
    
        
    
    <li>
        <a href="#">О платформе Эвотор</a>
        <ul>
            
            
            
            <li><a href="doc_introduction.html">Введение</a></li>
            
            
            
            
            
            
            <li><a href="doc_application_test.html">Тестирование приложения</a></li>
            
            
            
            
            
            
            <li><a href="doc_glossary.html">Термины и определения</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Интеграция с платформой</a>
        <ul>
            
            
            
            <li><a href="doc_release_notes.html">История изменений API и SDK</a></li>
            
            
            
            
            
            
            <li><a href="doc_evotor_rest_api_calls.html">Запросы к облаку Эвотор</a></li>
            
            
            
            
            
            
            <li><a href="doc_outgoing_calls_protocol.html">Запросы к стороннему сервису</a></li>
            
            
            
            
            
            
            <li><a href="doc_smart_terminal_applications.html">Приложения для смарт-терминала</a></li>
            
            
            
            
            
            
            <li><a href="doc_smart_terminal_documents.html">Документы смарт-терминала</a></li>
            
            
            
            
            
            
            <li><a href="doc_errors_returned.html">Возвращаемые ошибки</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Примеры реализации</a>
        <ul>
            
            
            
            <li><a href="doc_cloud_systems_integration.html">Облачная товароучётная система</a></li>
            
            
            
            
            
            
            <li><a href="doc_iframe_within_application_page.html">IFrame на странице приложения</a></li>
            
            
            
            
            
            
            <li><a href="doc_smart_terminal_application.html">Приложение для смарт-терминала</a></li>
            
            
            
            
            
            
            <li><a href="doc_1C_integration.html">Интеграция с 1С</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">SDK смарт-терминала</a>
        <ul>
            
            
            
            <li><a href="doc_smart_terminal_native.html">Главный экран смарт-терминала</a></li>
            
            
            
            
            
            
            <li class="active"><a href="doc_smart_terminal_webview.html">Права доступа</a></li>
            
            
            
            
            
            
            <li><a href="doc_smart_terminal_logging.html">Логирование данных</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Публикация приложения</a>
        <ul>
            
            
            
            <li><a href="doc_acceptance_testing.html">Приёмочное тестирование</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Продажа</a>
        <ul>
            
            
            
            <li><a href="doc_legal_scheme.html">Юридическая схема</a></li>
            
            
            
            
            
            
            <li><a href="doc_applications_tariffs.html">Тарифы приложений</a></li>
            
            
            
            
            
            
            <li><a href="doc_conditions.html">Условия</a></li>
            
            
            
            
            
            
            <li><a href="doc_marketing.html">Продвижение</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">FAQ</a>
        <ul>
            
            
            
            <li><a href="doc_faq.html">Часто задаваемые вопросы</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Разработка вебвью приложения для смарт-терминала</h1>
</div>



<div class="post-content">

   
    <div class="summary">Раздел содержит информацию о процессе разработки вебвью приложения для смарт-терминала.</div>
   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

  <h3 id="Структура-проекта">Структура проекта</h3>

<p>Общая структура проекта:</p>

<p><code class="highlighter-rouge">client.yaml</code> — файл с описанием разрешений для приложения, указаниями файлов, адреса view, для отображения и т.д.</p>

<p>Папка <code class="highlighter-rouge">client</code>:</p>
<ul>
  <li>
    <p><code class="highlighter-rouge">daemons</code> — папка, в которой находятся файлы js, которые будут выполнятся асинхронно (в примере отслеживаются события кассы)<br />
<em>Примечание!</em> При отправке события в daemon из терминала, daemons не передает callback в приложение терминала, он работает только с внутренними данными самого приложения, т.е. результат работы daemon необходимо сохранять отдельно, например, в storage, чтобы затем им воспользоваться;</p>
  </li>
  <li><code class="highlighter-rouge">uiPlugins</code> — папка, в которой находятся файлы js, которые выполняются перед отображением <code class="highlighter-rouge">WebView</code> (может не отображаться);</li>
  <li><code class="highlighter-rouge">view</code> — папка с html файлами, стилями, скриптами и т.д., которые будут отображены в <code class="highlighter-rouge">WebView</code>.<br />
<em>Примечание!</em> Вызывать <code class="highlighter-rouge">view</code> не обязательно если нет необходимости отображать UI, но вызвать метод интерфейса <code class="highlighter-rouge">navigation.pushNext()</code> для передачи результатов в терминал необходимо, даже если WebView не вызывается;</li>
</ul>

<p>Файл архива клиента распаковывается в папку <code class="highlighter-rouge">assets</code> андроид приложения.<br />
В корне должен находиться файл с описанием структуры проекта <code class="highlighter-rouge">client.yaml</code>.</p>

<p>Пример содержания:</p>

<div class="language-yaml highlighter-rouge"><span class="na">version</span><span class="pi">:</span> <span class="s">2</span>  
<span class="na">versionName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.0.1"</span>
<span class="na">packageName</span><span class="pi">:</span> <span class="s">Test</span>
<span class="na">appName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">testApp"</span>
<span class="na">appUUID</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2e6dc4b8-fdac-48c1-8a1a-ade402863947"</span>
<span class="na">iconColor</span><span class="pi">:</span> <span class="s2">"</span><span class="s">#0f70b7"</span>
<span class="na">capabilities</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">inventory</span>
  <span class="pi">-</span> <span class="s">storage</span>
  <span class="pi">-</span> <span class="s">http</span>
  <span class="pi">-</span> <span class="s">event-bus</span>
  <span class="pi">-</span> <span class="s">receipts</span>
<span class="na">daemons</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">check</span>
    <span class="na">events</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">evo.receipt.opened</span>
      <span class="pi">-</span> <span class="s">evo.receipt.productAdded</span>
      <span class="pi">-</span> <span class="s">evo.receipt.productRemoved</span>
      <span class="pi">-</span> <span class="s">evo.receipt.closed</span>
      <span class="pi">-</span> <span class="s">evo.receipt.clear</span>
    <span class="na">behavior</span><span class="pi">:</span> <span class="s">check-daemon.js</span>
<span class="na">plugins</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">discount</span>
    <span class="na">moments</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">evo.payments.process</span>
    <span class="pi">-</span> <span class="s">evo.payments.beforePrintReceipt</span>
    <span class="na">point</span><span class="pi">:</span> <span class="s">before</span>
    <span class="na">behavior</span><span class="pi">:</span> <span class="s">before-receipt-fixed.js</span>
<span class="na">views</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">discount-loader</span>
    <span class="na">header</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Подождите"</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">client/views/discount-loader/view.html</span>
    <span class="na">styles</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">*.css"</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">launcher</span>
    <span class="na">header</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Подождите"</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">client/views/discount-loader/view.html</span>
    <span class="na">styles</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">*.css"</span>
</div>

<p><em>Где:</em><br />
<code class="highlighter-rouge">version: 2</code> — Код версии приложения (инкремент этого параметра значит, что приложение изменилось и его необходимо обновить на терминалах)<br />
<code class="highlighter-rouge">versionName: "1.0.1"</code> — Версия приложения (версия служит просто для отображения пользователю, можно писать что угодно)<br />
<code class="highlighter-rouge">packageName: org.example.myApp</code> — Имя пакета (используйте правила соглашения об именовании – https://docs.oracle.com/javase/tutorial/java/package/namingpkgs.html)<br />
<code class="highlighter-rouge">appName: "testApp"</code> — Отображаемое пользователю имя приложения<br />
<code class="highlighter-rouge">appUUID: "2e6dc4b8-fdac-48c1-8a1a-ade402863947"</code> — UUID приложения (его можно посмотреть в адресной строке приложения на dev.evotor.ru в личном кабинете разработчика)<br />
<code class="highlighter-rouge">iconColor: "#0f70b7"</code> — Цвет иконки приложения интеграции на терминале Evotor, если она размещена на рабочем столе (см. описание <code class="highlighter-rouge">views</code>, чтобы поместить иконку приложения на главный экран терминала)<br />
<code class="highlighter-rouge">capabilities:</code>  — Разрешения на использование интерфейсов, которые запрашивает приложение<br />
`  - inventory<code class="highlighter-rouge">  
</code>  - storage<code class="highlighter-rouge">  
</code>  - http<code class="highlighter-rouge">  
</code>  - event-bus<code class="highlighter-rouge">  
</code>  - receipts`</p>

<p><code class="highlighter-rouge">daemons:</code> — Процессы-демоны (скрипт, реагирующший на события, указанные в списке events)<br />
`  - name: check<code class="highlighter-rouge"> — Имя  
</code>    events:<code class="highlighter-rouge"> — События, на которые он подписан  
</code>      - evo.receipt.opened<code class="highlighter-rouge"> — чек открыт  
</code>      - evo.receipt.productAdded<code class="highlighter-rouge"> — товар добавлен  
</code>      - evo.receipt.productRemoved<code class="highlighter-rouge"> —  товар удален  
</code>      - evo.receipt.closed<code class="highlighter-rouge"> — чек закрыт  
</code>      - evo.receipt.clear<code class="highlighter-rouge"> — чек удален  
</code>    behavior: check-daemon.js<code class="highlighter-rouge"> — скрипт, который будет запущен как реакция на событие демонов (Внутри </code>handleEvent<code class="highlighter-rouge"> - void метод, который должен вызываться из скрипта чтобы реагировать на событие терминала. Где параметры: </code>handleEvent(integrationEvent)<code class="highlighter-rouge">, и где </code>integrationEvent` - это js объект, содержащий информацию о событии.)</p>

<p><code class="highlighter-rouge">plugins:</code> — собирает и подготавливает данные для отображения пользователя и вызывает <code class="highlighter-rouge">WebView</code> (реагирует на события, указанные в списке moments)<br />
`  - name: discount<code class="highlighter-rouge"> — Имя    
</code>    moments:<code class="highlighter-rouge"> — События, на которые он подписан  
</code>    - evo.payments.process<code class="highlighter-rouge"> — переход на экран оплаты чека (переход к оплате чека), на этом этапе чек уже сформирован  
</code>    - evo.payments.beforePrintReceipt<code class="highlighter-rouge"> —  когда оплата уже проведена, а печать еще не началась  
</code>    point: before<code class="highlighter-rouge"> — признак вызова plugins до завершения события moments (пока работает только before)  
</code>    behavior: before-receipt-fixed.js<code class="highlighter-rouge"> — скрипт, который будет запущен как реакция на событие плагинов (Внутри </code>HandleMoment<code class="highlighter-rouge"> - void метод, который должен вызываться из скрипта чтобы реагировать на событие терминала. Где параметры: </code>handleMoment(integrationContext, navigation)`.)</p>

<p><code class="highlighter-rouge">views:</code> — список html загружаются внутрь <code class="highlighter-rouge">WebView</code>, которые затем можно отобразить пользователю в UI<br />
`  - name: karamba<code class="highlighter-rouge"> — Любое название </code>view<code class="highlighter-rouge">, по которому к нему можно обратиться  
</code>    header: “Подождите”<code class="highlighter-rouge"> — Заголовок окна  
</code>    source: client/views/discount-loader/view.html<code class="highlighter-rouge"> — Полный путь к html файлу  
</code>    styles:<code class="highlighter-rouge"> — список стилей которые должны быть подключены  
</code>      - “<em>.css”<code class="highlighter-rouge"> — может подключить все файлы  
</code>  - name: launcher<code class="highlighter-rouge"> — Если необходимо запускать WebView с главного экрана, необходимо в названии написать </code>launcher<code class="highlighter-rouge">, но он может быть только один (только одна иконка на главном экране приложения)  
</code>    header: “Подождите”<code class="highlighter-rouge"> — Заголовок, при отображении в </code>WebView<code class="highlighter-rouge">  
</code>    source: client/views/discount-loader/view.html<code class="highlighter-rouge"> — Полный путь к html файлу  
</code>    styles:<code class="highlighter-rouge">  
</code>      - “</em>.css”`</p>

<p><a name="002"></a></p>
<h3 id="Работа-с-api-http">Работа с API HTTP</h3>
<p>Для использования возможности работы с сервером посредством http запросов, в файле скрипта используется java объект, контекст которого передается в Java Script.<br />
Работа в js с ним осуществляется, как с обычным js объектом.</p>

<p>Перед использованием API HTTP, необходимо явно указать необходимость использования данного функционала в скрипте:<br />
В начале js скрипта необходимо получить этот объект с помощью:</p>

<p><code class="highlighter-rouge"> var http = require('http')</code></p>

<p>И добавить в <code class="highlighter-rouge">client.yaml</code> соответствующий <code class="highlighter-rouge">capability</code>.</p>

<p>Далее в коде, после инициализации, можно вызывать метод этого объекта для отправки запроса, например:</p>
<pre><code class="language-1">function generateSuggestions(items) {
  var response = http.send({
    method : "POST",
    path : "recommendations",
    body : items
  })
  var jsonObject = JSON.parse(response)
}
</code></pre>
<p><em>Где:</em><br />
`  var response = http.send({       ` — Вызов метода<br />
`    method : “POST”,               ` — Тип запроса (POST/GET/PUT/DELETE/HEAD)<br />
`    path : “recommendations”,      ` — URL на сервере<br />
`    body : items                   ` — Тело запроса (тип данных для <code class="highlighter-rouge">WebView</code> — только строка, а в <code class="highlighter-rouge">Demons</code> или <code class="highlighter-rouge">UIPlugin</code> любой тип данных)<br />
`  var jsonObject = JSON.parse(response)  ` — В ответе получаем строку, которую приводим к JSON объекту<br />
                                              (в следующей версии будет передаваться сразу объект)</p>

<p>Данный функционал возможно использовать не только в сервисах-демонах, в <code class="highlighter-rouge">WebView</code> данный код тоже будет работать.</p>

<p><a name="003"></a></p>
<h3 id="Работа-с-webview">Работа с WebView</h3>
<p>Отображение <code class="highlighter-rouge">WebView</code> происходит при вызове у интерфейса <code class="highlighter-rouge">navigation</code> метода:</p>
<pre><code class="language-1">pushView(...)
</code></pre>
<p>куда передается полный путь к html файлу страницы из <code class="highlighter-rouge">view.source</code> для открытия, где поддерживается использование css, javascript.<br />
Работа с Java интерфейсами внутри <code class="highlighter-rouge">WebView</code> несколько отличается от работы с ними в процессах-демонах:<br />
Доступные интерфейсы в <code class="highlighter-rouge">WebView</code>:</p>

<p><code class="highlighter-rouge">navigation</code> — Работа с навигацией<br />
<code class="highlighter-rouge">jsData</code> — Интерфейс данных интеграции для передачи в webView<br />
<code class="highlighter-rouge">Receipt</code> — Работа с чеком<br />
<code class="highlighter-rouge">RPC</code> — Доступ для отправки http запросов<br />
<code class="highlighter-rouge">storage</code> — Работа с БД интеграции<br />
<code class="highlighter-rouge">Logger</code> — Работа с логированием данных</p>

<p>Для работы с ними нет необходимости получать их через синтаксис required, они уже интегрированы в <code class="highlighter-rouge">WebView</code>.<br />
Работать с ними можно как с локальными переменными, без их объявления.</p>

<p><a name="004"></a></p>
<h3 id="Работа-с-навигацией-api-navigation">Работа с навигацией (API navigation)</h3>
<p><code class="highlighter-rouge">API navigation</code> используется для работы с <code class="highlighter-rouge">WebView</code>.</p>

<p>Для использования функционала, необходимо явно указать о намерении использования в скрипте, работа происходит через java объект, контекст которого передается в Java Script, далее работа с ним ведется, как с обычным js объектом.<br />
Для инициализации объекта, в начале скрипта указываем:</p>

<p>Для работы с интерфейсом в сервисе-демоне:</p>
<pre><code class="language-1">var navigation = require('navigation');
</code></pre>
<p>Для работы с интерфейсом в <code class="highlighter-rouge">WebView</code>: ничего указывать не нужно, по умолчанию, интерфейс навигации уже передан во <code class="highlighter-rouge">WebView</code>, для использования обращаемся к нему, как к уже созданному объекту с именем navigation, объявлять его не нужно.</p>

<p>Доступные функции в интерфейсе:</p>
<pre><code class="language-1">pushNext
pushView
</code></pre>
<p><em>Где:</em>
<code class="highlighter-rouge">pushNext()</code> — используется для перехода к следующему экрану:
При открытом <code class="highlighter-rouge">WebView</code> — закрывает его и возвращает пользователя в EvoPos, при этом в кассу передается стек операций, который представляет из себя набор действий: добавление товара в чек, удаление товара из чека, применение скидки к чеку или к отдельно выбранному товару.</p>

<p><code class="highlighter-rouge">pushView(String name, String data)</code> — где:</p>
<ul>
  <li><code class="highlighter-rouge">viewLocation</code> — адрес html страницы для открытия в <code class="highlighter-rouge">WebView</code></li>
  <li><code class="highlighter-rouge">data</code> — строка для данных, которые должны быть переданы в <code class="highlighter-rouge">WebView</code>, обычно используется json формат</li>
</ul>

<p>Пример работы:</p>
<pre><code class="language-1">navigation.pushView("client/views/suggestion-list/view.html", {
  suggestions: suggestedProducts,
  receipt: receipt
});
</code></pre>
<p>Для получения данных в открывшемся <code class="highlighter-rouge">WebView</code> используется интерфейс jsData, имеющий метод <code class="highlighter-rouge">getData()</code>, возвращающий данные в строковом представлении, переданные через метод <code class="highlighter-rouge">pushView()</code>.</p>

<p>Пример использования:</p>
<pre><code class="language-1">var passedData  = JSON.parse(jsData.getData());
</code></pre>

<p><a name="005"></a></p>
<h3 id="Работа-с-БД-Интеграции-api-storage">Работа с БД Интеграции (API storage)</h3>

<p><code class="highlighter-rouge">storage</code> – система хранения данных в формате ключ – значение.</p>

<p>Для работы с API необходимо в манифесте приложения указать:</p>
<pre><code class="language-1">capabilities:
 - storage
</code></pre>

<p>Объект для работы с API вызывается функцией:</p>
<pre><code class="language-1">var storage = require('storage')
</code></pre>

<p>Далее используются две функции:</p>

<ul>
  <li>Сохранение данных:
    <pre><code class="language-1">storage.set(key, value)
</code></pre>
    <p>Функция возвращает <code class="highlighter-rouge">true</code> в случае успешного сохранения, <code class="highlighter-rouge">false</code> если произошла ошибка.<br />
key и value – строковые переменные</p>
  </li>
  <li>Получение данных:
    <pre><code class="language-1">storage.get(key)
</code></pre>
    <p>Функция возвращает строковую переменную ранее записанную в хранилище, либо <code class="highlighter-rouge">null</code>, если значение не было найдено.<br />
<code class="highlighter-rouge">key</code> – строковая переменная</p>
  </li>
</ul>

<p><a name="006"></a></p>
<h3 id="Работа-с-БД-Терминала-api-inventory">Работа с БД Терминала (API inventory)</h3>

<p><code class="highlighter-rouge">API inventory</code> используется для доступа к базе данных устройства, конкретнее, к таблице, содержащей информацию о товарах.<br />
Для использования функционала, необходимо явно указать о намерении использования в скрипте.<br />
Работа происходит через java объект, контекст которого передается в Java Script, далее работа с ним ведется, как с обычным js объектом.<br />
Для инициализации объекта, в начале скрипта указываем:</p>
<pre><code class="language-1">var inventory = require('inventory');
</code></pre>
<p>После этого, мы имеем доступ к методам этого объекта, на данный момент, реализован метод, для получения информации по конкретному товару в базе данных устройства.<br />
Для ее получения, необходимо передать в функцию уникальный uuid товара.<br />
Например:</p>
<pre><code class="language-1">function getProduct(productUID){
        return inventory.getProduct(productUID);
    }
</code></pre>
<p>Результатом работы функции будет JSON объект в строковом представлении, вида:</p>

<pre><code class="language-1">{
  "ID":"136",
  "UUID":"1196da34-e4a8-4915-8e92-bd7792875d76",
  "CODE":"4",
  "CODE_UPPER_CASE":"4",
  "NAME":"вино апсны",
  "NAME_UPPER_CASE":"ВИНО АПСНЫ",
  "IS_GROUP":"0",
  "IS_FAVORITE":"0",
  "MEASURE_ID":"1",
  "PRICE_OUT":"20000",
  "COST_PRICE":"0",
  "QUANTITY":"-1000",
  "TAX_NUMBER":"VAT_18",
  "ABBREVIATION":"ВНП",
  "TILE_COLOR":"-26624",
  "TYPE":"NORMAL",
  "ALCOHOL_BY_VOLUME":"0",
  "ALCOHOL_PRODUCT_KIND_CODE":"0",
  "TARE_VOLUME":"0",
  "SELL_FORBIDDEN":"0",
  "DESCRIPTION":"",
  "ARTICLE_NUMBER":"",
  "ARTICLE_NUMBER_UPPER_CASE":""
}
</code></pre>
<p>Если, товар с указанным uuid не будет найден в базе, то результатом будет строка с пустым JSON объектом:</p>
<pre><code class="language-1">{
}
</code></pre>
<p>Данный функционал возможно использовать не только в сервисах-демонах, в <code class="highlighter-rouge">WebView</code> данный код тоже будет работать.</p>

<p><a name="007"></a></p>
<h3 id="Логирование-данных-api-logging">Логирование данных (API logging)</h3>

<p>Функционал для логирования
Объект, через который осуществляется логгирование получается функцией <code class="highlighter-rouge">require</code>:</p>
<pre><code class="language-1">var logger = require('logger')
</code></pre>
<p>Далее у объекта вызывается функция:</p>
<pre><code class="language-1">logger.log(value)
</code></pre>
<p>После выполнения функции в logcat устройства будет выведена строка <code class="highlighter-rouge">value</code></p>

<p><a name="008"></a></p>
<h3 id="Список-стандартных-api">Список стандартных API</h3>

<p><a name="008"></a></p>
<h4 id="1-Добавление-товара-в-чек">1. Добавление товара в чек</h4>
<p>Управление чеком доступно через <code class="highlighter-rouge">receipt api</code>, для этого используем метод:<br />
<code class="highlighter-rouge">receipt.addPosition(uuid: String)</code> — добавление товара в чек</p>

<p><a name="009"></a></p>
<h4 id="2-Удаление-товара-из-чека">2. Удаление товара из чека</h4>
<p>Управление чеком доступно через <code class="highlighter-rouge">receipt api</code>, для этого используем метод:<br />
<code class="highlighter-rouge">receipt.removePosition(uuid: String)</code> — удаление из чека товара, который уже был добавлен через ‘addPosition’</p>

<p><a name="010"></a></p>
<h4 id="3-Применение-скидки-на-чек">3. Применение скидки на чек</h4>
<p>Управление чеком доступно через <code class="highlighter-rouge">receipt api</code>, для этого используем метод:<br />
<code class="highlighter-rouge">receipt.applyReceiptDiscountPercent(discount: Double)</code> — применение скидки ко всему чеку, процентное значение</p>

<p><a name="011"></a></p>
<h4 id="4-Получить-итоговый-чек-при-переходе-к-оплате">4. Получить итоговый чек при переходе к оплате</h4>

<p>Для получения всего чека используем:</p>

<p><code class="highlighter-rouge">receipt.getReceipt()</code><br />
<em>Примечание:</em> для использования <code class="highlighter-rouge">receipt.getReceipt()</code> нужно декларировать <code class="highlighter-rouge">var receipt = require('receiptControl')</code><br />
Возвращает строку в JSON формате (формат данных содержимого json - строки) :</p>
<pre><code class="language-1"> {
    "receiptData": {
        "totalSum": "218.50",
        "discountPercents": "0.000000",
        "totalSumWithoutDiscount": "218.50",
        "positionDiscountSum": "0.00",
        "positionsCount": "4",
        "extraData": "{}"
    },
    "receiptPositions": [{
        "uuid": "070efd1b-4f53-401a-b5c1-cb31b5e9072d",
        "type": "NORMAL",
        "code": "1",
        "measure": "шт",
        "price": "56",
        "priceWithDiscount": "56",
        "quantity": "1"
    }, {
        "uuid": "9d2fdacd-969c-41f2-b360-a5ebbddcbe9e",
        "type": "NORMAL",
        "code": "131",
        "measure": "шт",
        "price": "30.5",
        "priceWithDiscount": "30.5",
        "quantity": "5"
    }, {
        "uuid": "7c916c19-756d-4b3d-806e-63c090080a3d",
        "type": "NORMAL",
        "code": "129",
        "measure": "шт",
        "price": "9",
        "priceWithDiscount": "9",
        "quantity": "1"
    }, {
        "uuid": "9dd36300-647e-4863-81b2-eb9591bc599b",
        "type": "NORMAL",
        "code": "127",
        "measure": "шт",
        "price": "1",
        "priceWithDiscount": "1",
        "quantity": "1"
    }]
}
</code></pre>

<p><a name="012"></a></p>
<h4 id="5-Разделить-чек-по-позициям-на-несколько-чеков-группы-печати">5. Разделить чек по позициям на несколько чеков (группы печати)</h4>

<p>Группы печати, где для задания группы печати на позицию, используется метод:</p>
<pre><code class="language-1">edited
receipt.addPositionPrintGroup(JSON String)
 в качестве параметра
 var addPositionPrintGroup = {
    "uuid": "e82a113b-0d76-424f-9ad5-c6595ca57770",
    "code": "4", — код товара
    "printGroupId" : "4dc2-3fcd",
    "printGroupIsFiscal" : true,
    "printGroupOrgName" : "Andrew",
    "printGroupOrgInn": "88005553535",
    "printGroupPaymentSum" : "123.00"
};
edited
</code></pre>
<p><em>Где:</em><br />
<code class="highlighter-rouge">"uuid": "e82a113b-0d76-424f-9ad5-c6595ca57770"</code> — uuid товара<br />
<code class="highlighter-rouge">"code": "4"</code> — код товара<br />
<code class="highlighter-rouge">"printGroupId" : "4dc2-3fcd"</code> — id группы печати<br />
<code class="highlighter-rouge">"printGroupIsFiscal" : true</code> — признак фискальности<br />
<code class="highlighter-rouge">"printGroupOrgName" : "Andrew"</code> — имя группы<br />
<code class="highlighter-rouge">"printGroupOrgInn": "88005553535"</code> — ИНН<br />
<code class="highlighter-rouge">"printGroupPaymentSum" : "123.00"</code>— Сумма товаров в группе</p>

<p><a name="013"></a></p>
<h4 id="6-Получить-все-подключенные-пинпады">6. Получить все подключенные пинпады</h4>
<pre><code class="language-1">Devices.getAvailableDevicesIds()
</code></pre>
<p>Возвращает массив данных со всеми пин-падами, подключенными к терминалу:<br />
<em>Где поля, описывающие каждый платежный терминал:</em><br />
<code class="highlighter-rouge">deviceId</code> — id устройства<br />
<code class="highlighter-rouge">userDescription</code> — Пользовательское описание<br />
<code class="highlighter-rouge">model</code> — Модель устройства<br />
<code class="highlighter-rouge">vendor</code> — Производитель устройства</p>

<p><a name="014"></a></p>
<h4 id="7-Оплатить-мультичек-на-пинпаде">7. Оплатить мультичек на пинпаде</h4>
<p><code class="highlighter-rouge">receipt.addPaymentOperation(JSON String)</code></p>

<p>Принимает на вход принимает JSON, который описывает структуру оплаты для разбиения общего чека на платежи:</p>
<pre><code class="language-1">var paymentOperation = {
  "uuid": "1ef45g5",
  "deviceUUID": "smth",
  "paymentSum" : "123.00",
  "isCashless" : true,
  "printGroups" : [
  {
      "printGroupId" : "4dc2-3fcd",
      "printGroupIsFiscal" : true,
      "printGroupOrgName" : "Andrew",
      "printGroupPaymentSum" : "123.00",
      "printGroupOrgInn": "88005553535"
   }
  ]
};
</code></pre>
<p><em>Где:</em><br />
<code class="highlighter-rouge">"uuid": "1ef45g5"</code> — уникальный идентификатор для каждой оплаты (генерируется со стороны интеграции - уникальность должна гарантироваться в рамках одного чека, а тип данных String дает возможность использовать любые сгенерированные последовательности знаков)<br />
<code class="highlighter-rouge">"deviceUUID": "smth"</code> — идентификатор устройства, на котором выполняется оплата (идентификатор, получаемый через наше апи 6. “Получить все подключенные пинпады”)<br />
<code class="highlighter-rouge">"paymentSum" : "123.00"</code> — сумма платежа<br />
<code class="highlighter-rouge">"isCashless" : true</code> — признак картой/нал (true, если используется пин-пад, проставляется со стороны приложения. В событие evo.payments.process содержатся данные о типе оплаты, поле “isCashless”)<br />
<code class="highlighter-rouge">"printGroups" :</code>  — список групп печати в оплате</p>

<p><a name="015"></a></p>
<h4 id="8-Записать-в-итоговый-чек-экстра-данные-интеграции">8. Записать в итоговый чек экстра данные интеграции</h4>
<p>Все необходимые данные интеграция может добавить в нужном ей формате как дополнительную информацию по документу чека продажи:</p>
<pre><code class="language-1">receipt.addExtraReceiptData(String extraData)
</code></pre>

<p><a name="016"></a></p>
<h3 id="Список-точек-интеграции">Список точек интеграции</h3>

<p><a name="016"></a></p>
<h4 id="1-Выбран-тип-оплаты">1. Выбран тип оплаты</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">action evo.payments.process
</code></pre>
<p>Где есть признак, является ли оплата безналичной:</p>
<pre><code class="language-1">isCashless - тип boolean
</code></pre>

<p><a name="017"></a></p>
<h4 id="2-Оплата-документа-уже-выполнена-но-печать-еще-не-запущена">2. Оплата документа уже выполнена, но печать еще не запущена</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.payments.beforePrintReceipt
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="018"></a></p>
<h4 id="3-Окрываем-кассовый-ящик">3. Окрываем кассовый ящик</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.cashDrawer.opened
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="019"></a></p>
<h4 id="4-Изымаем-деньги-из-кассы">4. Изымаем деньги из кассы</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.cashOperations.cashOut
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="020"></a></p>
<h4 id="5-Открываем-карточку-редактирования-товара">5. Открываем карточку редактирования товара</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.commodity.cardOpened
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="012"></a></p>
<h4 id="6-Закрываем-документ-продаживозврата">6. Закрываем документ продажи/возврата</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.receipt.closed
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="022"></a></p>
<h4 id="7-Добавляем-позицию-в-чек">7. Добавляем позицию в чек</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.receipt.productAdded
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="023"></a></p>
<h4 id="8-Удаляем-позицию-из-чека">8. Удаляем позицию из чека</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.receipt.productRemoved
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="024"></a></p>
<h4 id="9-Удаляем-чек-отмена-всего-чека">9. Удаляем чек (отмена всего чека)</h4>

<p>Прилетает событие:</p>
<pre><code class="language-1">evo.receipt.clear
</code></pre>
<p>Нужно на него подписаться</p>

<p><a name="025"></a></p>
<h3 id="api-Облака-для-партнеров">API Облака для партнеров</h3>

<p>В вашем кабинете на dev.evotor.ru нужно зарегистрировать приложение “Название приложения”.<br />
Для разработки нужен uuid приложения, uuid приложения можно посмотреть в адресной строке.<br />
Также нужно прописать сервер приложения https:название приложения.название компании.ru, пока в кабинете разработчика не появится эта возможность.</p>

<p>Если присутствует необходимость серверной интеграции, тогда нужно предварительно авторизовывать пользовательские запросы.<br />
Для этого нужен пользовательский токен. Чтобы его получить - нужно поддержать нотацию API:<br />
https://api.evotor.ru/docs/?url=/docs/v1/evotor-to-partner.json#!/Управление_учетными_записями</p>

<p><a name="025"></a></p>
<h4 id="1-Изменение-схемы-продуктов-для-магазина">1. Изменение схемы продуктов для магазина</h4>

<p>У товара в магазине для одного приложения может быть одно экстра-поле внутри него любой валидный json (например поле с массивом объектов которые могут вам понадобиться на терминале).<br />
У того же товара в том же магазине, но для другого приложения эстра поле будет другим. Когда к апи обращаются с токеном приложения то GET и POST будет влиять на экстраполя того приложения с токеном которого обращаются.</p>

<p>В 1 приложении должна быть только 1 схема, которая покрывает все экстра данного приложения. В перспективе можно будет менять схему для нескольких приложений (тогда пригодиться массив по appId, но пока это ограничено на уровне прав доступа по токену в запросе, который имеет право изменять только соответствующую схему приложения).</p>

<p>Запрос:
https://test-api.evotor.ru/api/v1/inventories/stores/{store-uuid}/products/schemes</p>
<pre><code class="language-1">POST
    -
    H "Content-Type: application/json;charset=utf-8" -
    H "X-Auth-Token: {токен}" -
    d '[  {
        "uuid": "{uuid-схемы-продуктов-в-магазине}",
        "appId": "{uuid-приложения-в-маркетплейсе}",
        "items": [{
                "title": "Произвольный заголовок поля ввода текста",
                "editable": false,
                "regexp": "\w+", // валидный регексп
                "uuid": "{uuid-поля-1}",
                "type": "TEXT_FIELD",
                "data": {} // валидный JSON с произвольными данными доступными из JS на терминале
            },
            {
                "editable": true,
                "title": "Произвольный заголовок поля выбора из списка",
                "uuid": "{uuid-поля-2}",
                "items": [{
                        "data": {}, // валидный JSON с произвольными данными доступными из JS на терминале
                        "title": "Заголовок первого варианта выбора",
                        "value": "10"
                    },
                    {
                        "data": {}, // валидный JSON с произвольными данными доступными из JS на терминале
                        "title": "Special title",
                        "value": "20"
                    }
                ],
                "type": "DICTIONARY_FIELD"
            }
        ]
    }]
'
</code></pre>
<p>Статусы ответов:</p>
<pre><code class="language-1">200 - Успех
400 - Ошибка "Bad Request"
401 - Ошибка "Unauthorized"
</code></pre>

<p>В пример запроса описаны 2 поля, где 1 поле - текстовое поле, где title = “Произвольный заголовок поля ввода текста” и 2 поле - выбор из списка, где title = “Произвольный заголовок поля выбора из списка”.<br />
Где items.title - это заголовок поля и заголовок окна при выборе одновременно, а items.items.title - это заголовок одного значения из списка возможных предопределенных значений.<br />
Добавлять значения “экстра полей” для всех productUuid можно как одним POST запросом, так и по частями, например по 100 позиций.</p>

<p><a name="026"></a></p>
<h4 id="2-Получение-схемы-продуктов-для-магазина">2. Получение схемы продуктов для магазина</h4>

<p>Запрос:
https://test-api.evotor.ru/api/v1/inventories/stores/{store-uuid}/products/schemes</p>
<pre><code class="language-1">    GET
    -
    H "Content-Type: application/json;charset=utf-8" -
    H "X-Authorization: {токен}"
</code></pre>
<p>Статусы ответов:</p>
<pre><code class="language-1">200 - Успех
400 - Ошибка "Bad Request"
401 - Ошибка "Unauthorized"
</code></pre>

<p><a name="027"></a></p>
<h4 id="3-Добавление-конкретных-значений-экстра-в-товары-для-магазина">3. Добавление конкретных значений экстра в товары для магазина</h4>

<p>Запрос: https://test-api.evotor.ru/api/v1/inventories/stores/{store-uuid}/products/extras</p>
<pre><code class="language-1">curl - X POST - H "Content-Type: application/json" -
    H "Content-Type: application/json;charset=utf-8" -
    H "X-Auth-Token: test-token-1" - d ' [  {
        "uuid": "{uuid-экстра-поля-1}",
        "appId": "{uuid-приложения-в-маркетплейсе}",
        "key": {
            "uuid": "{uuid-продукта-связанного-с-экстра-полем}",
        },
        "scheme": { // Секция данных привязки значения экстра поля к контролу отображаемому на терминале
                    // (не требуется если экстра данные не нужно отобржатаь в меню терминал)
            "value": "20",
            "fieldId": "{uuid-поля-из-схемы-отображения-продукта}"
        },
        "data": {}, // валидный JSON с произвольными данными доступными из JS на терминале
    }]
'
</code></pre>
<p>Статусы ответов:</p>
<pre><code class="language-1">200 - Успех
400 - Ошибка "Bad Request"
401 - Ошибка "Unauthorized"
</code></pre>

<p><a name="028"></a></p>
<h4 id="4-Получение-конкретных-значений-экстра-товаров-в-магазине">4. Получение конкретных значений экстра товаров в магазине</h4>

<p>Запрос: https://test-api.evotor.ru/api/v1/inventories/stores/test-store/products/extras</p>
<pre><code class="language-1">curl - XGET\ -
    H "Content-Type: application/json;charset=utf-8" -
    H "X-Authorization: {токен}"
</code></pre>
<p>Статусы ответов:</p>
<pre><code class="language-1">200 - Успех
400 - Ошибка "Bad Request"
401 - Ошибка "Unauthorized"
</code></pre>

<p><a name="029"></a></p>
<h4 id="5-Получение-документов-чека-и-их-экстра-данных">5. Получение документов чека и их экстра данных</h4>

<p>Запрос: https://test-api.evotor.ru/api/v1/inventories/stores/{store-uuid}/documents?deviceUuid</p>
<pre><code class="language-1">GET
headers = {
    Content - Type = [application / json;charset = UTF - 8];
    accept - encoding = [gzip];
    x - authorization = [{
        user - application1 - token
    }]
};
req payload = ;
resp status = 200;
resp payload = [{
    "uuid": "5285ab1b-2ecb-4614-87f7-99b1486a04fe",
    "type": "OPEN_SESSION",
    "deviceId": "352398080047279",
    "deviceUuid": "8ffbe447-79d0-4fd9-823a-6da96d7f0be9",
    ...стандарнтые поля модели документа Эвотор...
    "extras": {
        "{application1-uuid}": {
            валидный_джейсон_со_значениями_эстра,
            application1 - uuid соответсвующий user - application1 - token - у
        }
    }
}]
</code></pre>
<p>Статусы ответов:</p>
<pre><code class="language-1">200 - Успех
400 - Ошибка "Bad Request"
401 - Ошибка "Unauthorized"
</code></pre>


    <div class="tags">
        
    </div>

    

</div>

<hr class="shaded"/>

    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>